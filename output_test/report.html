<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow AI Scan Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 5px;
        }

        .header .date-range {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }

        .content {
            padding: 40px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            border-left: 4px solid #667eea;
        }

        .kpi-card.high-risk {
            border-left-color: #ef4444;
        }

        .kpi-card.shadow-ai {
            border-left-color: #f59e0b;
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 0.95em;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-description {
            font-size: 0.85em;
            color: #9ca3af;
            margin-top: 8px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .profile-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 40px;
            border-left: 4px solid #f59e0b;
        }

        .profile-box p {
            font-size: 1.1em;
            color: #78350f;
            line-height: 1.6;
        }

        .risk-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .risk-card {
            background: #fee;
            border-radius: 8px;
            padding: 25px;
            border-left: 4px solid #ef4444;
        }

        .risk-card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #991b1b;
            margin-bottom: 12px;
        }

        .risk-card-description {
            font-size: 1em;
            color: #7f1d1d;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .risk-card-next-step {
            font-size: 0.95em;
            color: #dc2626;
            font-weight: 600;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .next-steps {
            background: #eff6ff;
            border-radius: 8px;
            padding: 30px;
            border-left: 4px solid #3b82f6;
        }

        .next-steps h3 {
            font-size: 1.5em;
            color: #1e40af;
            margin-bottom: 15px;
        }

        .next-steps ul {
            list-style: none;
            padding: 0;
        }

        .next-steps li {
            font-size: 1.05em;
            color: #1e40af;
            padding: 12px 0;
            padding-left: 30px;
            position: relative;
            line-height: 1.6;
        }

        .next-steps li:before {
            content: "→";
            position: absolute;
            left: 0;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Event Table Styles */
        .filters-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #4b5563;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .event-table-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .event-table thead {
            background: #667eea;
            color: white;
        }

        .event-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .event-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9em;
        }

        .event-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .event-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-badge.high {
            background: #fee;
            color: #dc2626;
        }

        .risk-badge.medium {
            background: #fef3c7;
            color: #d97706;
        }

        .risk-badge.low {
            background: #d1fae5;
            color: #059669;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: #4b5563;
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-right: 40px;
        }

        .modal-body {
            color: #4b5563;
            line-height: 1.6;
        }

        .event-detail-section {
            margin-bottom: 20px;
        }

        .event-detail-label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .event-detail-value {
            color: #6b7280;
            word-break: break-word;
        }

        .risk-reasons-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .risk-reasons-list li {
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .follow-up-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .follow-up-list li {
            padding: 10px 12px;
            background: #eff6ff;
            border-radius: 6px;
            margin-bottom: 8px;
            padding-left: 30px;
            position: relative;
        }

        .follow-up-list li:before {
            content: "→";
            position: absolute;
            left: 10px;
            color: #3b82f6;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .kpi-grid,
            .charts-grid,
            .risk-cards {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                grid-template-columns: 1fr;
            }

            .event-table {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Shadow AI Scan Report</h1>
            <p>Snapshot of AI usage across your organization</p>
            <div class="date-range">
                Log coverage: 2025-11-23T09:15:32 to 2025-11-24T15:35:42
            </div>
        </div>

        <div class="content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">14</div>
                    <div class="kpi-label">Total AI Events</div>
                    <div class="kpi-description">AI-related requests detected in network logs</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-value">14</div>
                    <div class="kpi-label">Unique Users Using AI</div>
                    <div class="kpi-description">Individual employees accessing AI tools</div>
                </div>

                <div class="kpi-card shadow-ai">
                    <div class="kpi-value">100.0%</div>
                    <div class="kpi-label">Shadow AI Share</div>
                    <div class="kpi-description">14 events to unsanctioned tools</div>
                </div>

                <div class="kpi-card high-risk">
                    <div class="kpi-value">7</div>
                    <div class="kpi-label">High-Risk Events</div>
                    <div class="kpi-description">50.0% of total events</div>
                </div>
            </div>

            <!-- Shadow AI Profile -->
            <div class="section">
                <h2 class="section-title">Shadow AI Profile</h2>
                <div class="profile-box">
                    <p>Most AI usage is in Engineering (21%) and Claims (21%). About 100.0% of all AI events go to unsanctioned or unknown AI tools.</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="section">
                <h2 class="section-title">Usage Analytics</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Risk Breakdown</div>
                        <canvas id="riskChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">AI Usage by Department</div>
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Risks -->
            <div class="section">
                <h2 class="section-title">Top 3 Risks</h2>
                <div class="risk-cards">
                    
                    <div class="risk-card">
                        <div class="risk-card-title">Claims team using public AI tools</div>
                        <div class="risk-card-description">Detected 3 high-risk AI events from the Claims department. This department handles sensitive data that should not be processed by external AI systems.</div>
                        <div class="risk-card-next-step">
                            <strong>Next Step:</strong> Immediately review Claims team's AI usage policies and provide approved alternatives.
                        </div>
                    </div>
                    <div class="risk-card">
                        <div class="risk-card-title">Unknown AI tools in use with no governance</div>
                        <div class="risk-card-description">Found 2 events using unidentified AI services. These tools are outside IT visibility and may pose compliance risks.</div>
                        <div class="risk-card-next-step">
                            <strong>Next Step:</strong> Conduct an AI tool inventory and establish an approved vendor list.
                        </div>
                    </div>
                    <div class="risk-card">
                        <div class="risk-card-title">Significant data being sent to AI providers</div>
                        <div class="risk-card-description">Detected 5 events with large data transfers (>4KB). This may indicate employees uploading documents or sensitive information.</div>
                        <div class="risk-card-next-step">
                            <strong>Next Step:</strong> Implement DLP controls and train employees on data handling policies.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="section">
                <div class="next-steps">
                    <h3>Recommended Next Steps</h3>
                    <ul>
                        <li>Run a full AI Risk &amp; Readiness Assessment based on these findings</li>
                        <li>Define a sanctioned AI toolkit and usage policy for high-sensitivity teams</li>
                        <li>Implement ongoing AI usage monitoring and governance</li>
                        <li>Launch an AI enablement program to meet employee demand safely</li>
                    </ul>
                </div>
            </div>

            <!-- Event Details Section -->
            <div class="section" id="event-details">
                <h2 class="section-title">Event Details</h2>

                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Risk Level</label>
                        <select id="filter-risk">
                            <option value="all">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Department</label>
                        <select id="filter-department">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Provider</label>
                        <select id="filter-provider">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" id="filter-search" placeholder="Search by user, dept, provider, URL...">
                    </div>
                </div>

                <!-- Event Table -->
                <div class="event-table-container">
                    <table class="event-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Department</th>
                                <th>Provider</th>
                                <th>Risk</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody id="event-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <button id="event-modal-close" class="modal-close">&times;</button>
            <h3 class="modal-title">Event Details</h3>
            <div id="event-modal-body" class="modal-body">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Embedded event and summary data
        window.SHADOW_AI_EVENTS = [{"id": "evt_061426f49389", "timestamp": "2025-11-23T09:15:32", "user_email": "sarah.chen@company.com", "department": "Clinical", "source_ip": "192.168.1.45", "provider": "openai", "service": "chat", "url": "https://api.openai.com/v1/chat/completions?patient=12345", "bytes_sent": 12500, "bytes_received": 2145, "risk_level": "high", "risk_reasons": ["high_sensitivity_department", "large_data_transfer"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["large_payload", "high_sensitivity_large_payload", "pii_keyword_in_url:patient"], "use_case": "data_extraction"}, {"id": "evt_6ce32505abbe", "timestamp": "2025-11-23T10:22:15", "user_email": "john.doe@company.com", "department": "Engineering", "source_ip": "192.168.1.67", "provider": "github_copilot", "service": "code_assist", "url": "https://api.githubcopilot.com/completions", "bytes_sent": 1234, "bytes_received": 2345, "risk_level": "medium", "risk_reasons": ["external_ai_usage"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "code_assistance"}, {"id": "evt_3c27ef98e441", "timestamp": "2025-11-23T11:33:44", "user_email": "maria.garcia@company.com", "department": "Claims", "source_ip": "192.168.1.89", "provider": "anthropic", "service": "chat", "url": "https://api.anthropic.com/v1/messages", "bytes_sent": 15234, "bytes_received": 3456, "risk_level": "high", "risk_reasons": ["high_sensitivity_department", "large_data_transfer"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["large_payload", "high_sensitivity_large_payload"], "use_case": "data_extraction"}, {"id": "evt_0ec8573a8fce", "timestamp": "2025-11-23T13:15:22", "user_email": "alex.wong@company.com", "department": "Finance", "source_ip": "192.168.1.102", "provider": "anthropic", "service": "web_ui", "url": "https://claude.ai/chat/new", "bytes_sent": 512, "bytes_received": 12456, "risk_level": "medium", "risk_reasons": ["medium_sensitivity_department"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "content_generation"}, {"id": "evt_d688c9e371fd", "timestamp": "2025-11-23T14:45:11", "user_email": "emily.johnson@company.com", "department": "Legal", "source_ip": "192.168.1.123", "provider": "openai", "service": "chat", "url": "https://api.openai.com/v1/chat/completions?record=ssn-123-45-6789", "bytes_sent": 8912, "bytes_received": 4567, "risk_level": "high", "risk_reasons": ["high_sensitivity_department", "large_data_transfer"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["high_sensitivity_large_payload", "pii_keyword_in_url:record", "ssn_pattern_in_url"], "use_case": "analysis_or_chat"}, {"id": "evt_ba4611ce1933", "timestamp": "2025-11-23T15:22:33", "user_email": "david.kim@company.com", "department": "Engineering", "source_ip": "192.168.1.67", "provider": "github_copilot", "service": "code_assist", "url": "https://api.githubcopilot.com/completions", "bytes_sent": 987, "bytes_received": 1234, "risk_level": "medium", "risk_reasons": ["external_ai_usage"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "code_assistance"}, {"id": "evt_ecb9c7f16971", "timestamp": "2025-11-23T16:05:44", "user_email": "lisa.patel@company.com", "department": "HR", "source_ip": "192.168.1.134", "provider": "google", "service": "chat", "url": "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent", "bytes_sent": 2345, "bytes_received": 3456, "risk_level": "medium", "risk_reasons": ["medium_sensitivity_department"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "analysis_or_chat"}, {"id": "evt_e6c12da4ed8a", "timestamp": "2025-11-24T09:15:32", "user_email": "michael.brown@company.com", "department": "Marketing", "source_ip": "192.168.1.156", "provider": "openai", "service": "web_ui", "url": "https://chat.openai.com/chat", "bytes_sent": 423, "bytes_received": 6789, "risk_level": "medium", "risk_reasons": ["external_ai_usage"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "content_generation"}, {"id": "evt_0b05d8765de4", "timestamp": "2025-11-24T10:05:17", "user_email": "jennifer.lee@company.com", "department": "Clinical", "source_ip": "192.168.1.45", "provider": "openai", "service": "embeddings", "url": "https://api.openai.com/v1/embeddings", "bytes_sent": 13456, "bytes_received": 1234, "risk_level": "high", "risk_reasons": ["high_sensitivity_department", "large_data_transfer"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["large_payload", "high_sensitivity_large_payload"], "use_case": "data_extraction"}, {"id": "evt_e0ca32f66c80", "timestamp": "2025-11-24T11:18:52", "user_email": "robert.martinez@company.com", "department": "Sales", "source_ip": "192.168.1.178", "provider": "perplexity", "service": "web_ui", "url": "https://perplexity.ai/search", "bytes_sent": 234, "bytes_received": 5678, "risk_level": "medium", "risk_reasons": ["external_ai_usage"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "unknown"}, {"id": "evt_9657b1a923c5", "timestamp": "2025-11-24T12:33:28", "user_email": "amanda.taylor@company.com", "department": "Claims", "source_ip": "192.168.1.89", "provider": "unknown", "service": "unknown", "url": "https://unknown-ai-saas.com/api/generate?patient=john.doe@example.com", "bytes_sent": 4567, "bytes_received": 2345, "risk_level": "high", "risk_reasons": ["unknown_ai_provider"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["high_sensitivity_large_payload", "pii_keyword_in_url:patient", "email_pattern_in_url"], "use_case": "unknown"}, {"id": "evt_cfb462c6ffdc", "timestamp": "2025-11-24T13:47:41", "user_email": "christopher.white@company.com", "department": "Finance", "source_ip": "192.168.1.102", "provider": "anthropic", "service": "chat", "url": "https://api.anthropic.com/v1/messages", "bytes_sent": 11234, "bytes_received": 2345, "risk_level": "high", "risk_reasons": ["large_data_transfer"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["large_payload"], "use_case": "data_extraction"}, {"id": "evt_16487f160fdd", "timestamp": "2025-11-24T14:21:07", "user_email": "stephanie.lee@company.com", "department": "Claims", "source_ip": "192.168.1.89", "provider": "unknown", "service": "unknown", "url": "https://unknown-ai-saas.com/api/chat?claim=abc123", "bytes_sent": 5234, "bytes_received": 3456, "risk_level": "high", "risk_reasons": ["unknown_ai_provider"], "source_system": "network_logs_v1", "notes": null, "pii_risk": true, "pii_reasons": ["high_sensitivity_large_payload", "pii_keyword_in_url:claim"], "use_case": "unknown"}, {"id": "evt_68b4e0ef30b9", "timestamp": "2025-11-24T15:35:42", "user_email": "brian.wilson@company.com", "department": "Engineering", "source_ip": "192.168.1.67", "provider": "github_copilot", "service": "code_assist", "url": "https://api.githubcopilot.com/completions", "bytes_sent": 1456, "bytes_received": 2567, "risk_level": "medium", "risk_reasons": ["external_ai_usage"], "source_system": "network_logs_v1", "notes": null, "pii_risk": false, "pii_reasons": [], "use_case": "code_assistance"}];
        window.SHADOW_AI_SUMMARY = {"riskCounts": {"low": 0, "medium": 7, "high": 7}, "eventsByDept": {"Clinical": 2, "Engineering": 3, "Claims": 3, "Finance": 2, "Legal": 1, "HR": 1, "Marketing": 1, "Sales": 1}, "highRiskByDept": {"Clinical": 2, "Claims": 3, "Legal": 1, "Finance": 1}};

        // Risk Breakdown Chart (Donut)
        const riskCtx = document.getElementById('riskChart').getContext('2d');
        const riskChart = new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                datasets: [{
                    data: [
                        SHADOW_AI_SUMMARY.riskCounts.low || 0,
                        SHADOW_AI_SUMMARY.riskCounts.medium || 0,
                        SHADOW_AI_SUMMARY.riskCounts.high || 0
                    ],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14 },
                            padding: 15
                        }
                    }
                },
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const riskLevels = ['low', 'medium', 'high'];
                        filters.risk = riskLevels[index];
                        document.getElementById('filter-risk').value = filters.risk;
                        renderTable();

                        // Scroll to event details
                        document.getElementById('event-details').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        });

        // Department Chart (Bar)
        const deptLabels = Object.keys(SHADOW_AI_SUMMARY.eventsByDept || {});
        const deptData = Object.values(SHADOW_AI_SUMMARY.eventsByDept || {});
        const highRiskDeptData = deptLabels.map(dept => SHADOW_AI_SUMMARY.highRiskByDept[dept] || 0);

        const deptCtx = document.getElementById('deptChart').getContext('2d');
        const deptChart = new Chart(deptCtx, {
            type: 'bar',
            data: {
                labels: deptLabels,
                datasets: [
                    {
                        label: 'Total Events',
                        data: deptData,
                        backgroundColor: '#667eea',
                        borderRadius: 4
                    },
                    {
                        label: 'High Risk Events',
                        data: highRiskDeptData,
                        backgroundColor: '#ef4444',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14 },
                            padding: 15
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        filters.department = deptLabels[index];
                        document.getElementById('filter-department').value = filters.department;
                        renderTable();

                        // Scroll to event details
                        document.getElementById('event-details').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        });

        // ===== Event Filtering and Table Rendering =====

        // Global filters state
        const filters = {
            risk: 'all',
            department: 'all',
            provider: 'all',
            search: ''
        };

        // Initialize filter dropdowns
        function initializeFilters() {
            // Get unique departments and providers
            const departments = new Set();
            const providers = new Set();

            SHADOW_AI_EVENTS.forEach(event => {
                if (event.department) departments.add(event.department);
                if (event.provider) providers.add(event.provider);
            });

            // Populate department dropdown
            const deptSelect = document.getElementById('filter-department');
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });

            // Populate provider dropdown
            const providerSelect = document.getElementById('filter-provider');
            Array.from(providers).sort().forEach(provider => {
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                providerSelect.appendChild(option);
            });
        }

        // Filter events based on current filter state
        function filterEvents() {
            return SHADOW_AI_EVENTS.filter(event => {
                // Risk filter
                if (filters.risk !== 'all' && event.risk_level !== filters.risk) {
                    return false;
                }

                // Department filter
                if (filters.department !== 'all' && event.department !== filters.department) {
                    return false;
                }

                // Provider filter
                if (filters.provider !== 'all' && event.provider !== filters.provider) {
                    return false;
                }

                // Search filter (case-insensitive)
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const searchableText = [
                        event.user_email || '',
                        event.department || '',
                        event.provider || '',
                        event.url || ''
                    ].join(' ').toLowerCase();

                    if (!searchableText.includes(searchLower)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // Format timestamp for display
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Generate event summary text
        function generateEventSummary(event) {
            const dept = event.department || 'Unknown dept';
            const user = event.user_email || 'Unknown user';
            const provider = event.provider.charAt(0).toUpperCase() + event.provider.slice(1);
            const service = event.service.replace('_', ' ');
            const bytesSent = event.bytes_sent ? `${(event.bytes_sent / 1024).toFixed(1)} KB sent` : 'N/A';
            const risk = event.risk_level.charAt(0).toUpperCase() + event.risk_level.slice(1);

            return `${dept} user ${user} used ${provider} ${service} (${bytesSent}) – ${risk} Risk`;
        }

        // Render table with filtered events
        function renderTable() {
            const tbody = document.getElementById('event-table-body');
            const filteredEvents = filterEvents();

            // Limit to 50 rows
            const displayEvents = filteredEvents.slice(0, 50);

            // Clear existing rows
            tbody.innerHTML = '';

            if (displayEvents.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = 'No events match the current filters.';
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                cell.style.color = '#6b7280';
                return;
            }

            // Render rows
            displayEvents.forEach(event => {
                const row = tbody.insertRow();
                row.dataset.eventId = event.id;
                row.onclick = () => showEventModal(event.id);

                // Time
                const timeCell = row.insertCell();
                timeCell.textContent = formatTime(event.timestamp);

                // User
                const userCell = row.insertCell();
                userCell.textContent = event.user_email || 'N/A';

                // Department
                const deptCell = row.insertCell();
                deptCell.textContent = event.department || 'N/A';

                // Provider
                const providerCell = row.insertCell();
                providerCell.textContent = event.provider.charAt(0).toUpperCase() + event.provider.slice(1);

                // Risk
                const riskCell = row.insertCell();
                const riskBadge = document.createElement('span');
                riskBadge.className = `risk-badge ${event.risk_level}`;
                riskBadge.textContent = event.risk_level.toUpperCase();
                riskCell.appendChild(riskBadge);

                // Summary
                const summaryCell = row.insertCell();
                summaryCell.textContent = generateEventSummary(event);
            });
        }

        // ===== Event Detail Modal =====

        // Risk reason explanations
        const riskReasonExplanations = {
            'high_sensitivity_department': 'Department is classified as high-sensitivity (Clinical/Claims/Legal/Trading/Underwriting/Wealth Management).',
            'large_data_transfer': 'Large payload suggests full documents or records may be sent.',
            'unknown_ai_provider': 'This is an unknown AI provider outside your sanctioned tools.',
            'medium_sensitivity_department': 'Department handles moderately sensitive information (Finance/HR).',
            'external_ai_usage': 'External AI tool usage without governance.',
            'low_risk_ai_usage': 'Standard AI usage with lower risk profile.'
        };

        // Generate follow-up recommendations based on risk level
        function getFollowUpRecommendations(riskLevel) {
            switch (riskLevel) {
                case 'high':
                    return [
                        'Confirm whether sensitive/regulated data is being shared.',
                        'Discuss this usage with the department lead and evaluate safer alternatives.',
                        'Consider implementing immediate access controls or restrictions.'
                    ];
                case 'medium':
                    return [
                        'Review usage with the team and align with policy.',
                        'Ensure proper training on acceptable AI usage guidelines.'
                    ];
                case 'low':
                    return [
                        'Consider adding this to the sanctioned toolkit if appropriate.',
                        'Monitor for any changes in usage patterns.'
                    ];
                default:
                    return ['Review with IT security team.'];
            }
        }

        // Show event detail modal
        function showEventModal(eventId) {
            const event = SHADOW_AI_EVENTS.find(e => e.id === eventId);
            if (!event) return;

            const modal = document.getElementById('event-modal');
            const modalBody = document.getElementById('event-modal-body');

            // Build modal content
            let html = `
                <div class="event-detail-section">
                    <div class="event-detail-label">Timestamp</div>
                    <div class="event-detail-value">${new Date(event.timestamp).toLocaleString()}</div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">User</div>
                    <div class="event-detail-value">${event.user_email || 'N/A'}</div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Department</div>
                    <div class="event-detail-value">${event.department || 'N/A'}</div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Provider & Service</div>
                    <div class="event-detail-value">
                        ${event.provider.charAt(0).toUpperCase() + event.provider.slice(1)}
                        (${event.service.replace('_', ' ')})
                    </div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">URL</div>
                    <div class="event-detail-value">${truncateUrl(event.url, 80)}</div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Data Transfer</div>
                    <div class="event-detail-value">
                        Sent: ${event.bytes_sent ? (event.bytes_sent / 1024).toFixed(2) + ' KB' : 'N/A'} |
                        Received: ${event.bytes_received ? (event.bytes_received / 1024).toFixed(2) + ' KB' : 'N/A'}
                    </div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Risk Level</div>
                    <div class="event-detail-value">
                        <span class="risk-badge ${event.risk_level}">${event.risk_level.toUpperCase()}</span>
                    </div>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Risk Factors</div>
                    <ul class="risk-reasons-list">
                        ${event.risk_reasons.map(reason =>
                            `<li>${riskReasonExplanations[reason] || reason}</li>`
                        ).join('')}
                    </ul>
                </div>

                <div class="event-detail-section">
                    <div class="event-detail-label">Recommended Follow-up</div>
                    <ul class="follow-up-list">
                        ${getFollowUpRecommendations(event.risk_level).map(rec =>
                            `<li>${rec}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('show');
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('event-modal');
            modal.classList.remove('show');
        }

        // Truncate URL for display
        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength) + '...';
        }

        // ===== Event Listeners =====

        // Filter change listeners
        document.getElementById('filter-risk').addEventListener('change', (e) => {
            filters.risk = e.target.value;
            renderTable();
        });

        document.getElementById('filter-department').addEventListener('change', (e) => {
            filters.department = e.target.value;
            renderTable();
        });

        document.getElementById('filter-provider').addEventListener('change', (e) => {
            filters.provider = e.target.value;
            renderTable();
        });

        document.getElementById('filter-search').addEventListener('input', (e) => {
            filters.search = e.target.value;
            renderTable();
        });

        // Modal close listeners
        document.getElementById('event-modal-close').addEventListener('click', closeModal);
        document.getElementById('event-modal').addEventListener('click', (e) => {
            if (e.target.id === 'event-modal') {
                closeModal();
            }
        });

        // ===== Initialize =====
        initializeFilters();
        renderTable();
    </script>
</body>
</html>